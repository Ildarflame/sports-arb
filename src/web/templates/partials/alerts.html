{% if opportunities %}
{% for opp in opportunities %}
{% set d = opp.details if opp.details is mapping else {} %}
{% set is_suspicious = d.get('suspicious', false) %}
{% set is_exec = d.get('executable', false) %}
{% set sport = opp.sport|default('') %}
{% set is_draw_sport = sport in ('soccer', 'rugby', 'cricket') %}
{# Determine direction and prices #}
{% set buy_yes_plat = opp.platform_buy_yes|default('')|upper %}
{% set buy_no_plat = opp.platform_buy_no|default('')|upper %}
{# Executable buy prices (ask) — for midpoint_only arbs, use the midpoint prices #}
{% set is_midpoint_only = d.get('midpoint_only', false) %}
{% if buy_yes_plat == 'POLYMARKET' %}
    {% set yes_buy_price = opp.yes_price if is_midpoint_only else (d.get('poly_yes_ask') or opp.yes_price) %}
    {% set yes_mid = d.get('poly_yes') or opp.yes_price %}
    {% set no_buy_price = opp.no_price if (is_midpoint_only or not d.get('kalshi_yes_bid')) else (1.0 - d.get('kalshi_yes_bid')) %}
    {% set no_mid = d.get('kalshi_no') or opp.no_price %}
    {% set yes_url = d.get('poly_url', '') %}
    {% set no_url = d.get('kalshi_url', '') %}
    {% set yes_fee_pct = 2.0 %}
    {% set no_fee_pct = 1.5 %}
    {% set yes_plat_name = 'Polymarket' %}
    {% set no_plat_name = 'Kalshi' %}
{% else %}
    {% set yes_buy_price = opp.yes_price if is_midpoint_only else (d.get('kalshi_yes_ask') or opp.yes_price) %}
    {% set yes_mid = d.get('kalshi_yes') or opp.yes_price %}
    {% set no_buy_price = opp.no_price if (is_midpoint_only or not d.get('poly_yes_bid')) else (1.0 - d.get('poly_yes_bid')) %}
    {% set no_mid = d.get('poly_no') or opp.no_price %}
    {% set yes_url = d.get('kalshi_url', '') %}
    {% set no_url = d.get('poly_url', '') %}
    {% set yes_fee_pct = 1.5 %}
    {% set no_fee_pct = 2.0 %}
    {% set yes_plat_name = 'Kalshi' %}
    {% set no_plat_name = 'Polymarket' %}
{% endif %}
{% set total = opp.total_cost if opp.total_cost else 0 %}
{% set roi = opp.roi_after_fees if opp.roi_after_fees else 0 %}
{% set exec_cost = d.get('exec_cost') %}
{% set mid_cost = d.get('midpoint_cost') %}
{# Volume badges #}
{% set pvol = d.get('poly_volume') %}
{% set kvol = d.get('kalshi_volume') %}
{# Age from found_at #}
{% set found = opp.found_at if opp.found_at is string else '' %}

{% set conf = d.get('confidence', 'low') %}
{% set conf_class = 'conf-' ~ conf %}
<details class="arb-card {{ conf_class }} {{ 'suspicious' if is_suspicious else '' }}">
    <summary>
        <span class="dot {{ 'dot-exec' if is_exec else 'dot-mid' }}" title="{{ 'Executable bid/ask prices' if is_exec else 'Midpoint estimate' }}"></span>
        <span class="arb-event">{{ opp.team_a }} vs {{ opp.team_b }}</span>
        <span class="arb-strategy">{{ d.get('direction', 'YES@' ~ buy_yes_plat ~ ' + NO@' ~ buy_no_plat) }}</span>
        <span class="arb-cost">{{ "%.1f"|format(total * 100) }}c</span>
        {% if roi < 1 %}
            <span class="arb-roi roi-gray">+{{ "%.2f"|format(roi) }}%</span>
        {% elif roi < 3 %}
            <span class="arb-roi roi-green">+{{ "%.2f"|format(roi) }}%</span>
        {% elif roi < 5 %}
            <span class="arb-roi roi-bright">+{{ "%.2f"|format(roi) }}%</span>
        {% else %}
            <span class="arb-roi roi-gold">+{{ "%.2f"|format(roi) }}%</span>
        {% endif %}
        <span class="arb-meta">
            {% set conf = d.get('confidence', 'low') %}
            {% set poly_exec_str = 'bid/ask' if d.get('has_poly_exec') else 'mid' %}
            {% set kalshi_exec_str = 'bid/ask' if d.get('has_kalshi_exec') else 'mid' %}
            {% set conf_tooltip = conf|upper ~ ': Poly $' ~ "{:,.0f}".format(pvol or 0) ~ ' vol, ' ~ poly_exec_str ~ ' | Kalshi $' ~ "{:,.0f}".format(kvol or 0) ~ ' vol, ' ~ kalshi_exec_str %}
            {% if d.get('market_type') == 'futures' %}
                <span class="micro-badge" style="background: var(--blue)">FUTURES</span>
            {% endif %}
            {% if d.get('arb_type') == 'cross_team' %}
                <span class="micro-badge" style="background: var(--purple, #a855f7)">CROSS-TEAM</span>
            {% elif d.get('arb_type') == '3way' %}
                <span class="micro-badge" style="background: var(--green, #22c55e)">3-WAY</span>
            {% endif %}
            {% if d.get('is_live') %}
                <span class="micro-badge" style="background: var(--red, #ef4444); animation: pulse 2s infinite;">LIVE</span>
            {% endif %}
            {% if d.get('market_subtype') == 'spread' %}
                <span class="micro-badge" style="background: var(--orange, #f97316)">SPREAD {{ d.get('line') }}</span>
            {% elif d.get('market_subtype') == 'over_under' %}
                <span class="micro-badge" style="background: var(--teal, #14b8a6)">O/U {{ d.get('line')|abs if d.get('line') else '' }}</span>
            {% elif d.get('market_subtype') == 'map_winner' %}
                <span class="micro-badge" style="background: var(--cyan, #06b6d4)">MAP {{ d.get('map_number', '?') }}</span>
            {% endif %}
            {% if conf == 'high' %}
                <span class="micro-badge mb-conf-high" title="{{ conf_tooltip }}">HIGH</span>
            {% elif conf == 'medium' %}
                <span class="micro-badge mb-conf-med" title="{{ conf_tooltip }}">MED</span>
            {% else %}
                <span class="micro-badge mb-conf-low" title="{{ conf_tooltip }}">LOW</span>
            {% endif %}
            {% if d.get('spread_pct') is not none and d.get('spread_pct') > 10 %}
                <span class="micro-badge mb-spread-wide" title="Spread: {{ "%.0f"|format(d.get('spread_pct')) }}%">WIDE</span>
            {% endif %}
            {% if found %}
                <span class="micro-badge mb-age">{{ found }}</span>
            {% endif %}
            {% if opp.id %}
                <span class="micro-badge mb-age" style="cursor: pointer;"
                      title="Click to view ROI history"
                      hx-get="/partials/roi-history/{{ opp.id }}"
                      hx-target="#roi-spark-{{ opp.id }}"
                      hx-trigger="click once"
                      hx-swap="innerHTML">ROI ↗</span>
            {% endif %}
        </span>
    </summary>
    <div class="expand-body">
        {# ROI history sparkline container #}
        <div id="roi-spark-{{ opp.id }}" style="grid-column: 1 / -1;"></div>
        {# Left: How to execute #}
        <div>
            {% if is_suspicious %}
                <div class="suspicious-banner">{{ d.get('suspicious_reason', 'Flagged as suspicious') }}</div>
            {% endif %}
            {% if not is_exec %}
                <div style="padding: 0.3rem 0.6rem; font-size: 0.72rem; color: var(--yellow); background: rgba(234,179,8,0.08); border-radius: 4px; margin-bottom: 0.5rem;">
                    Нет стакана {{ 'на Polymarket' if not d.get('has_poly_exec') else '' }}{{ ' и ' if not d.get('has_poly_exec') and not d.get('has_kalshi_exec') else '' }}{{ 'на Kalshi' if not d.get('has_kalshi_exec') else '' }} &mdash; цены приблизительные (midpoint API), реальная цена покупки может отличаться
                </div>
            {% endif %}
            {% if d.get('poly_action') and d.get('kalshi_action') %}
            <div style="padding: 0.5rem; font-size: 0.8rem; background: rgba(34,197,94,0.1); border-radius: 4px; margin-bottom: 0.5rem; border: 1px solid rgba(34,197,94,0.3);">
                <strong style="color: var(--green);">Что делать:</strong><br>
                1. Polymarket: <strong>{{ d.get('poly_action') }}</strong><br>
                2. Kalshi: <strong>{{ d.get('kalshi_action') }}</strong>
            </div>
            {% endif %}
            <div class="exec-steps">
                {# Step 1: YES side #}
                <div class="exec-step">
                    <span class="step-num">1</span>
                    {% if yes_plat_name == 'Polymarket' %}
                        <span class="step-action">Polymarket:</span> Выбери <strong>{{ opp.team_a }}</strong> (кнопка &laquo;Buy&raquo;) &mdash;
                        ставишь на победу {{ opp.team_a }} по
                        <span class="step-price">{{ "%.1f"|format(yes_buy_price * 100) }}c</span>
                        {% if is_exec %}(best ask){% else %}(оценка){% endif %}
                        <div class="step-hint">На Polymarket это YES-контракт на {{ opp.team_a }}. Если {{ opp.team_a }} победит &rarr; получишь $1.</div>
                    {% else %}
                        <span class="step-action">Kalshi:</span> Найди маркет <strong>&laquo;{{ opp.team_a }}&raquo;</strong> и нажми <strong>Yes</strong> по
                        <span class="step-price">{{ "%.1f"|format(yes_buy_price * 100) }}c</span>
                        {% if is_exec %}(best ask){% else %}(оценка){% endif %}
                        <div class="step-hint">На Kalshi каждая команда &mdash; отдельный маркет с Yes/No. Тебе нужен именно Yes на {{ opp.team_a }}.</div>
                    {% endif %}
                    {% if yes_url %}
                    <div class="step-link"><a href="{{ yes_url }}" target="_blank" rel="noopener">Открыть {{ yes_plat_name }} &rarr;</a></div>
                    {% endif %}
                </div>
                {# Step 2: NO side #}
                <div class="exec-step">
                    <span class="step-num">2</span>
                    {% if no_plat_name == 'Polymarket' %}
                        {% if is_draw_sport %}
                            <span class="step-action">Polymarket:</span> На том же маркете <strong>{{ opp.team_a }}</strong> нажми <strong>&laquo;No&raquo;</strong> &mdash;
                            ставишь на то что {{ opp.team_a }} <em>не победит</em> по
                        {% else %}
                            <span class="step-action">Polymarket:</span> Выбери <strong>{{ opp.team_b }}</strong> (кнопка &laquo;Buy&raquo;) &mdash;
                            ставишь на победу {{ opp.team_b }} по
                        {% endif %}
                        <span class="step-price">{{ "%.1f"|format(no_buy_price * 100) }}c</span>
                        {% if is_exec %}(best ask){% else %}(оценка){% endif %}
                        {% if is_draw_sport %}
                            <div class="step-hint">NO = {{ opp.team_a }} не победит (ничья или поражение). Если {{ opp.team_a }} не выиграет &rarr; получишь $1.</div>
                        {% else %}
                            <div class="step-hint">Это то же самое что NO на {{ opp.team_a }}. Если {{ opp.team_a }} проиграет &rarr; получишь $1.</div>
                        {% endif %}
                    {% else %}
                        <span class="step-action">Kalshi:</span> Найди маркет <strong>&laquo;{{ opp.team_a }}&raquo;</strong> и нажми <strong>No</strong> по
                        <span class="step-price">{{ "%.1f"|format(no_buy_price * 100) }}c</span>
                        {% if is_exec %}(best ask){% else %}(оценка){% endif %}
                        {% if is_draw_sport %}
                            <div class="step-hint">No на маркете {{ opp.team_a }}. Если {{ opp.team_a }} не выиграет (ничья или поражение) &rarr; получишь $1.</div>
                        {% else %}
                            <div class="step-hint">Тот же маркет что в шаге 1, но кнопка No. Если {{ opp.team_a }} проиграет &rarr; получишь $1.</div>
                        {% endif %}
                    {% endif %}
                    {% if no_url %}
                    <div class="step-link"><a href="{{ no_url }}" target="_blank" rel="noopener">Открыть {{ no_plat_name }} &rarr;</a></div>
                    {% endif %}
                </div>
                <div class="exec-summary">
                    <div class="exec-summary-why">
                        {% if is_draw_sport %}
                            YES = {{ opp.team_a }} победит. NO = {{ opp.team_a }} не победит (ничья/поражение). Вместе покрывают все исходы.
                        {% else %}
                            Любой исход &rarr; одна из ставок платит $1. Вместе стоят {{ "%.1f"|format(total * 100) }}c &lt; 100c.
                        {% endif %}
                    </div>
                    Итого: {{ "%.1f"|format(total * 100) }}c &rarr; Выплата: 100c &rarr; Профит: +{{ "%.1f"|format((1.0 - total) * 100) }}c (+{{ "%.2f"|format(roi) }}%)
                </div>
            </div>
        </div>
        {# Right: Price verification grid #}
        <div>
            <table class="price-grid">
                <tr>
                    <th class="label-col"></th>
                    <th>Polymarket</th>
                    <th>Kalshi</th>
                </tr>
                <tr>
                    <td class="label-col">YES bid</td>
                    <td>{{ "%.1f"|format(d.get('poly_yes_bid') * 100) + 'c' if d.get('poly_yes_bid') else '--' }}</td>
                    <td>{{ "%.1f"|format(d.get('kalshi_yes_bid') * 100) + 'c' if d.get('kalshi_yes_bid') else '--' }}</td>
                </tr>
                <tr>
                    <td class="label-col">YES ask</td>
                    <td>{{ "%.1f"|format(d.get('poly_yes_ask') * 100) + 'c' if d.get('poly_yes_ask') else '--' }}</td>
                    <td>{{ "%.1f"|format(d.get('kalshi_yes_ask') * 100) + 'c' if d.get('kalshi_yes_ask') else '--' }}</td>
                </tr>
                <tr>
                    <td class="label-col">NO bid</td>
                    <td>{{ "%.1f"|format((1.0 - (d.get('poly_yes_ask') or 0)) * 100) + 'c' if d.get('poly_yes_ask') else '--' }}</td>
                    <td>{{ "%.1f"|format((1.0 - (d.get('kalshi_yes_ask') or 0)) * 100) + 'c' if d.get('kalshi_yes_ask') else '--' }}</td>
                </tr>
                <tr>
                    <td class="label-col">NO ask</td>
                    <td>{{ "%.1f"|format((1.0 - (d.get('poly_yes_bid') or 0)) * 100) + 'c' if d.get('poly_yes_bid') else '--' }}</td>
                    <td>{{ "%.1f"|format((1.0 - (d.get('kalshi_yes_bid') or 0)) * 100) + 'c' if d.get('kalshi_yes_bid') else '--' }}</td>
                </tr>
                {% if d.get('spread_pct') is not none %}
                <tr>
                    <td class="label-col">Spread</td>
                    <td colspan="2">{{ "%.1f"|format(d.get('spread_pct')) }}%</td>
                </tr>
                {% endif %}
                <tr>
                    <td class="label-col">Volume</td>
                    <td>{{ '$' + "{:,.0f}".format(pvol) if pvol else '--' }}</td>
                    <td>{{ '$' + "{:,.0f}".format(kvol) if kvol else '--' }}</td>
                </tr>
                <tr style="background: rgba(34,197,94,0.06);">
                    <td class="label-col" style="font-weight: 600; color: var(--green);">Exec price</td>
                    {% if buy_yes_plat == 'POLYMARKET' %}
                        <td><span class="highlight">{{ "%.1f"|format(yes_buy_price * 100) }}c</span> <span style="font-size: 0.65rem; color: var(--text-dim);">buy YES</span></td>
                        <td><span class="highlight">{{ "%.1f"|format(no_buy_price * 100) }}c</span> <span style="font-size: 0.65rem; color: var(--text-dim);">buy NO</span></td>
                    {% else %}
                        <td><span class="highlight">{{ "%.1f"|format(no_buy_price * 100) }}c</span> <span style="font-size: 0.65rem; color: var(--text-dim);">buy NO</span></td>
                        <td><span class="highlight">{{ "%.1f"|format(yes_buy_price * 100) }}c</span> <span style="font-size: 0.65rem; color: var(--text-dim);">buy YES</span></td>
                    {% endif %}
                </tr>
                {% if exec_cost %}
                <tr>
                    <td class="label-col">Total cost</td>
                    <td colspan="2"><span class="highlight">{{ "%.1f"|format(exec_cost * 100) }}c</span></td>
                </tr>
                {% endif %}
            </table>
            {# Bet Size Calculator #}
            <div style="margin-top: 0.8rem; padding: 0.5rem; background: rgba(59,130,246,0.08); border-radius: 4px; border: 1px solid rgba(59,130,246,0.2);">
                <div style="font-size: 0.72rem; font-weight: 600; color: var(--blue); margin-bottom: 0.4rem;">Calculator ($100 bankroll)</div>
                {% set fee_yes = 0.02 if buy_yes_plat == 'POLYMARKET' else 0.015 %}
                {% set fee_no = 0.015 if buy_yes_plat == 'POLYMARKET' else 0.02 %}
                {% set cost_yes_unit = yes_buy_price * (1 + fee_yes) %}
                {% set cost_no_unit = no_buy_price * (1 + fee_no) %}
                {% set total_unit = cost_yes_unit + cost_no_unit %}
                {% if total_unit > 0 %}
                    {% set units = 100.0 / total_unit %}
                    {% set yes_bet = cost_yes_unit * units %}
                    {% set no_bet = cost_no_unit * units %}
                    {% set profit = (1.0 - total_unit) * units %}
                    <div style="font-size: 0.75rem; line-height: 1.8;">
                        Buy YES on {{ yes_plat_name }}: <strong>${{ "%.2f"|format(yes_bet) }}</strong><br>
                        Buy NO on {{ no_plat_name }}: <strong>${{ "%.2f"|format(no_bet) }}</strong><br>
                        Guaranteed profit: <strong style="color: var(--green);">${{ "%.2f"|format(profit) }}</strong>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</details>
{% endfor %}
{% else %}
<div class="empty-state">
    <p>No arbitrage opportunities detected yet.</p>
</div>
{% endif %}
