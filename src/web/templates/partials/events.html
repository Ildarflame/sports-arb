{% if events %}
<table>
    <thead>
        <tr>
            <th>Event</th>
            <th>Polymarket</th>
            <th>Kalshi</th>
            <th>Volume</th>
            <th>ROI (w/ fees)</th>
        </tr>
    </thead>
    <tbody>
        {% for event in events %}
        {% set pm = event.markets.get(Platform.POLYMARKET) %}
        {% set km = event.markets.get(Platform.KALSHI) %}
        <tr>
            <td>
                {% if arb_teams is defined and event.team_a in arb_teams %}
                    <span class="dot dot-arb" style="width:6px;height:6px;vertical-align:middle;margin-right:4px" title="Active arb"></span>
                {% endif %}
                {% set sport = (pm.sport if pm else '') or (km.sport if km else '') %}
                {% if sport %}
                    <span class="badge badge-sport badge-sport-{{ sport }}">{{ sport|upper }}</span>
                {% endif %}
                {% set pm_type = pm.market_type if pm else '' %}
                {% set km_type = km.market_type if km else '' %}
                {% set is_futures = pm_type == 'futures' or km_type == 'futures' %}
                {% if is_futures %}
                    <span class="badge" style="background: var(--blue); color: white; font-size: 0.55rem; padding: 1px 5px;">FUTURES</span>
                {% endif %}
                {% set pm_subtype = pm.raw_data.get('market_subtype', 'moneyline') if pm else 'moneyline' %}
                {% set km_subtype = km.raw_data.get('market_subtype', 'moneyline') if km else 'moneyline' %}
                {% set subtype = pm_subtype if pm_subtype != 'moneyline' else km_subtype %}
                {% if subtype == 'spread' %}
                    <span class="badge" style="background: #7c3aed; color: white; font-size: 0.55rem; padding: 1px 5px;">SPREAD</span>
                {% elif subtype == 'over_under' %}
                    <span class="badge" style="background: #0891b2; color: white; font-size: 0.55rem; padding: 1px 5px;">O/U</span>
                {% endif %}
                <strong>{{ event.team_a }}</strong>
                {% set line_val = (pm.line if pm and pm.line is not none else None) or (km.line if km and km.line is not none else None) %}
                {% if line_val is not none %}
                    <span style="color: var(--yellow); font-size: 0.7rem;">{{ "%+.1f"|format(line_val) if subtype == 'spread' else "%.1f"|format(line_val) }}</span>
                {% endif %}
                {% if event.team_b %} vs <strong>{{ event.team_b }}</strong>{% endif %}
                {% if event.matched %}
                    <span class="badge badge-arb" style="margin-left: 4px; font-size: 0.6rem;">MATCHED</span>
                    {% if event.teams_swapped %}
                        <span class="badge" style="margin-left: 2px; font-size: 0.6rem; background: #f59e0b; color: #000;">SWAP</span>
                    {% endif %}
                {% endif %}
                {% set game_date = (pm.game_date if pm and pm.game_date else None) or (km.game_date if km and km.game_date else None) %}
                {% if game_date %}
                    <span style="color: var(--text-dim); font-size: 0.7rem; margin-left: 6px;">{{ game_date.strftime('%b %d') }}</span>
                {% endif %}
                <br>
                <span style="font-size: 0.7rem;">
                    {% if pm and pm.url %}
                        <a href="{{ pm.url }}" target="_blank" rel="noopener" style="color: #8b5cf6; text-decoration: none;" title="Open on Polymarket">Poly ↗</a>
                    {% endif %}
                    {% if pm and pm.url and km and km.url %} · {% endif %}
                    {% if km and km.url %}
                        <a href="{{ km.url }}" target="_blank" rel="noopener" style="color: #10b981; text-decoration: none;" title="Open on Kalshi">Kalshi ↗</a>
                    {% endif %}
                </span>
            </td>
            <td>
                {% if pm and pm.price %}
                    <span class="badge badge-poly">{{ "%.0f"|format(pm.price.yes_price * 100) }}</span>/<span style="color:var(--text-dim)">{{ "%.0f"|format(pm.price.no_price * 100) }}c</span>
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td>
                {% if km and km.price %}
                    <span class="badge badge-kalshi">{{ "%.0f"|format(km.price.yes_price * 100) }}</span>/<span style="color:var(--text-dim)">{{ "%.0f"|format(km.price.no_price * 100) }}c</span>
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td style="font-size: 0.75rem; color: var(--text-dim);">
                {% if pm and pm.price and pm.price.volume %}
                    ${{ "{:,.0f}".format(pm.price.volume) }}
                {% elif km and km.price and km.price.volume %}
                    ${{ "{:,.0f}".format(km.price.volume) }}
                {% else %}
                    --
                {% endif %}
            </td>
            <td>
                {% if event.matched and pm and pm.price and km and km.price %}
                    {% if event.teams_swapped %}
                        {% set k_yes_price = km.price.no_price %}
                        {% set k_no_price = km.price.yes_price %}
                        {% set k_yes_ask = (1.0 - km.price.yes_bid) if km.price.yes_bid else km.price.no_ask %}
                        {% set k_yes_bid = (1.0 - km.price.yes_ask) if km.price.yes_ask else km.price.no_bid %}
                    {% else %}
                        {% set k_yes_price = km.price.yes_price %}
                        {% set k_no_price = km.price.no_price %}
                        {% set k_yes_ask = km.price.yes_ask %}
                        {% set k_yes_bid = km.price.yes_bid %}
                    {% endif %}
                    {% set py_exec = pm.price.yes_ask if pm.price.yes_ask else pm.price.yes_price %}
                    {% set kn_exec = (1.0 - k_yes_bid) if k_yes_bid else k_no_price %}
                    {% set cost1 = py_exec + kn_exec %}
                    {% set fee1 = py_exec * 0.02 + kn_exec * 0.015 %}
                    {% set roi1 = ((1.0 - cost1 - fee1) / (cost1 + fee1) * 100) if cost1 + fee1 > 0 else -100 %}
                    {% set ky_exec = k_yes_ask if k_yes_ask else k_yes_price %}
                    {% set pn_exec = (1.0 - pm.price.yes_bid) if pm.price.yes_bid else pm.price.no_price %}
                    {% set cost2 = ky_exec + pn_exec %}
                    {% set fee2 = ky_exec * 0.015 + pn_exec * 0.02 %}
                    {% set roi2 = ((1.0 - cost2 - fee2) / (cost2 + fee2) * 100) if cost2 + fee2 > 0 else -100 %}
                    {% set best_roi = [roi1, roi2]|max %}
                    {% set has_exec = (pm.price.yes_ask or pm.price.yes_bid) and (km.price.yes_ask or km.price.yes_bid) %}
                    <span class="{{ 'arb-positive' if best_roi > 0 else 'arb-negative' }}">
                        {{ "%+.1f"|format(best_roi) }}%
                    </span>
                    {% if has_exec %}
                        <span style="color:#10b981;font-size:0.6rem" title="Calculated from bid/ask prices">EXEC</span>
                    {% else %}
                        <span style="color:#ff6b6b;font-size:0.6rem" title="Midpoint estimate only">MID</span>
                    {% endif %}
                {% elif not event.matched %}
                    {% set km_sport = (km.sport if km else '') %}
                    <span style="color: var(--text-dim); font-size: 0.75rem;">Kalshi only</span>
                    {% if km_sport %}
                        <span class="badge badge-sport badge-sport-{{ km_sport }}" style="margin-left: 4px;">{{ km_sport|upper }}</span>
                    {% endif %}
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{# Kalshi-only counter by sport #}
{% set unmatched = events|selectattr('matched', 'equalto', false)|list %}
{% if unmatched %}
<div style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-dim);">
    {{ unmatched|length }} Kalshi-only
    {% set ns = namespace(counts={}) %}
    {% for e in unmatched %}
        {% set km = e.markets.get(Platform.KALSHI) %}
        {% if km and km.sport %}
            {% if km.sport in ns.counts %}
                {% set _ = ns.counts.update({km.sport: ns.counts[km.sport] + 1}) %}
            {% else %}
                {% set _ = ns.counts.update({km.sport: 1}) %}
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if ns.counts %}
        ({% for sport, cnt in ns.counts.items() %}{{ cnt }} {{ sport|upper }}{% if not loop.last %}, {% endif %}{% endfor %})
    {% endif %}
</div>
{% endif %}
{% if scan_metrics_by_sport %}
<div style="margin-top: 0.6rem; font-size: 0.65rem; color: var(--text-dim); display: flex; gap: 0.8rem; flex-wrap: wrap;">
    <span style="font-weight: 600;">Scan timing:</span>
    {% for sport, dur in scan_metrics_by_sport.items()|sort %}
        <span><span class="badge badge-sport badge-sport-{{ sport }}" style="font-size: 0.55rem; padding: 0px 4px;">{{ sport|upper }}</span> {{ dur }}s</span>
    {% endfor %}
</div>
{% endif %}
{% else %}
<div class="empty-state">
    <p>No events yet. Scanning markets...</p>
</div>
{% endif %}
