{% if events %}
<table>
    <thead>
        <tr>
            <th>Event</th>
            <th>Polymarket YES</th>
            <th>Polymarket NO</th>
            <th>Kalshi YES</th>
            <th>Kalshi NO</th>
            <th>ROI (w/ fees)</th>
        </tr>
    </thead>
    <tbody>
        {% for event in events %}
        {% set pm = event.markets.get(Platform.POLYMARKET) %}
        {% set km = event.markets.get(Platform.KALSHI) %}
        <tr>
            <td>
                {% set sport = (pm.sport if pm else '') or (km.sport if km else '') %}
                {% if sport %}
                    <span class="badge badge-sport badge-sport-{{ sport }}">{{ sport|upper }}</span>
                {% endif %}
                <strong>{{ event.team_a }}</strong>
                {% if event.team_b %} vs <strong>{{ event.team_b }}</strong>{% endif %}
                {% if event.matched %}
                    <span class="badge badge-arb" style="margin-left: 4px; font-size: 0.6rem;">MATCHED</span>
                {% endif %}
                {% set game_date = (pm.game_date if pm and pm.game_date else None) or (km.game_date if km and km.game_date else None) %}
                {% if game_date %}
                    <span style="color: var(--text-dim); font-size: 0.7rem; margin-left: 6px;">{{ game_date.strftime('%b %d') }}</span>
                {% endif %}
                <br>
                <span style="font-size: 0.7rem;">
                    {% if pm and pm.url %}
                        <a href="{{ pm.url }}" target="_blank" rel="noopener" style="color: #8b5cf6; text-decoration: none;" title="Open on Polymarket">Poly ↗</a>
                    {% endif %}
                    {% if pm and pm.url and km and km.url %} · {% endif %}
                    {% if km and km.url %}
                        <a href="{{ km.url }}" target="_blank" rel="noopener" style="color: #10b981; text-decoration: none;" title="Open on Kalshi">Kalshi ↗</a>
                    {% endif %}
                </span>
            </td>
            <td>
                {% if pm and pm.price %}
                    <span class="badge badge-poly">{{ "%.1f"|format(pm.price.yes_price * 100) }}c</span>
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td>
                {% if pm and pm.price %}
                    {{ "%.1f"|format(pm.price.no_price * 100) }}c
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td>
                {% if km and km.price %}
                    <span class="badge badge-kalshi">{{ "%.1f"|format(km.price.yes_price * 100) }}c</span>
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td>
                {% if km and km.price %}
                    {{ "%.1f"|format(km.price.no_price * 100) }}c
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
            <td>
                {% if event.matched and pm and pm.price and km and km.price %}
                    {# Direction 1: YES@Poly + NO@Kalshi — use executable prices #}
                    {% set py_exec = pm.price.yes_ask if pm.price.yes_ask else pm.price.yes_price %}
                    {% set kn_exec = (1.0 - km.price.yes_bid) if km.price.yes_bid else km.price.no_price %}
                    {% set cost1 = py_exec + kn_exec %}
                    {% set fee1 = py_exec * 0.02 + kn_exec * 0.015 %}
                    {% set roi1 = ((1.0 - cost1 - fee1) / (cost1 + fee1) * 100) if cost1 + fee1 > 0 else -100 %}
                    {# Direction 2: YES@Kalshi + NO@Poly — use executable prices #}
                    {% set ky_exec = km.price.yes_ask if km.price.yes_ask else km.price.yes_price %}
                    {% set pn_exec = (1.0 - pm.price.yes_bid) if pm.price.yes_bid else pm.price.no_price %}
                    {% set cost2 = ky_exec + pn_exec %}
                    {% set fee2 = ky_exec * 0.015 + pn_exec * 0.02 %}
                    {% set roi2 = ((1.0 - cost2 - fee2) / (cost2 + fee2) * 100) if cost2 + fee2 > 0 else -100 %}
                    {% set best_roi = [roi1, roi2]|max %}
                    {% set has_exec = (pm.price.yes_ask or pm.price.yes_bid) and (km.price.yes_ask or km.price.yes_bid) %}
                    <span class="{{ 'arb-positive' if best_roi > 0 else 'arb-negative' }}">
                        {{ "%+.1f"|format(best_roi) }}%
                    </span>
                    {% if has_exec %}
                        <span style="color:#10b981;font-size:0.6rem" title="Calculated from bid/ask prices">EXEC</span>
                    {% else %}
                        <span style="color:#ff6b6b;font-size:0.6rem" title="Midpoint estimate only">MID</span>
                    {% endif %}
                {% elif not event.matched %}
                    <span style="color: var(--text-dim); font-size: 0.75rem;">Kalshi only</span>
                {% else %}
                    <span style="color: var(--text-dim)">--</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">
    <p>No events yet. Scanning markets...</p>
</div>
{% endif %}
